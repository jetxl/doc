#private
<h1>关于CRM前端架构总结</h1>


# 存在的问题：
刚来到CRM时，发现有大量的重复代码非常的惊讶，但随着之后的了解后又觉得这是必然的，因为CRM中有很多轻应用（类似于小程序），每一个应用是一个单页应用打包成一个HTML，webpack根据入口文件配置自动打包，但是因为产品把时间压得太紧，在新项目加入时并没有去做提取重构，而是直接复制一份代码接着开发，并且很多应用都是并行开发，导致一些本来可以通用的组件没有提取出来，久而久之就导致了项目目前的现状：
> 1. 大量的相似代码出现，甚至在解决bug时把解决的代码复制到多个地方
> 2. 同一个功能组件有多套版本，设计改版时导致统一网站存在多套样式

# 分析原因：
这样的后果是当产品结束了快速迭代新功能而主要以维护和改版优化为主的阶段时，工作量非常大。我从进入CRM开始一直在思考怎么去优化这个前端项目，我分析原因主要有以下几点：
> 1. 前端缺少沟通，因为诸多原因前端没有时间也没有人能够推动技术会议，而他们之间的缺少交流导致团队技术水平参差不齐，即使有人有想法但是无法推广，各自都在埋头苦干，但意识达不到统一，我私下问过他们其实一开始也尝试过codereview或者技术分享，但是效果不显著大家都不愿浪费时间参会。
> 2. 缺少前端leader，没有主干怎么会有凝聚力呢，没有凝聚力即使再好的想法也很难推动
> 3. 需要一个更好的前端结构，能改变目前这种窘困的状况


# 所以我的方法：
准备前端会议，到底什么样内容才能吸引他们，让他们真正的获得好处，让每一个成员都赞同这样的会议是必须的，而且如何让刚进入部门工作2年的我组织这样的会议不会惹来争议：首先私下充分的和成员交流，建立基本的情感基础，在群里时不时提出项目不合理之处和改进方法（尽管一直都没有一个人回应），向领导提出建议让领导支持我，收集足够多的实用的技术分享要点，提供解决现状的技术方法，等待一个项目比较空闲的间隙预定会议，最重要的就是会议上的演讲了。最后我得到了我想要的结果，尽管这花了很长的时间。
这样的话前2点原因都得到了解决，而后面就是改造前端的重点也是核心——按业务模块的组件化开发


# 现在CRM的前端团队开发模式是：
每一个应用都有2个人负责，当这个应用需要改动时尽量指定责任人去改造，这样对于自己负责的应用会更加了解，日后如果需要整体改造，比如所有的表格页面都要改版，这样分配到每一个负责人平均工作量，能得到很快的响应。毕竟以前同一个应用都是被N个人改过，因为是敏捷开发的模式，当一个小组完成某一个迭代时会开始另一个迭代（可能是另外一个应用或者新应用），而这个时候之前的任务需要再次改动时只能抽取其他小组来，多次改动后即使是一开始创建应用的人也都已经完全不知道其业务，如果这个应用出了问题甚至都不知道该指派谁去解决。


# 我的想法是按业务模块的组件化开发：

但是我觉得这并不能解决根本问题，一个相似的功能改版工作总量依然是N倍，看起来快只是因为有多个人同时在进行。所以我提出了一个比较大胆的想法，取消按应用分配人，直接按业务模块开发和分组，比如把表格页面做成一个由多个通用组件封装而成的业务组件（后期可以考虑做成npm包），这个业务组件中包含了多个应用的特性，就像天猫的首页是由多个项目甚至不同的部门编写的模块合并打包的一样，这样可以最大程度的减少重复的代码，而且可以使开发人员更加专注于当前模块的质量提升


如果一个人对应用负责，这个应用用到了很多不包含业务的组件，而这些组件并不一定满足特定的业务，为了这些特性同时不影响其他应用的功能，只能在这个组件上面再封装，久而久之不同的业务都对这个组件有一些封装，而如果这个组件需要改版时根本无从下手，因为如果改动了很有可能会导致别人在这个组件上封装的逻辑出错，那就只能拷贝一份或者干脆重做一份，就又陷入之前一个项目有多套相同功能的组件的尴尬局面了，而且开发的工作就是在不断的改改改，复制粘贴；而如果是按业务模块划分，同一组件对所有应用的特性都在组件中以配置的形式处理，需要改版时也能快速的将整个网站的样式交互统一，并且开发人员因为是一直负责这个业务功能，为了能更好的兼容多个业务，需要在扩展性和解耦有更多的思考，这样组件的质量就必然得到了提升。

# 后续工作：
+ 但这样的改动甚至连前端开发人员的思路都需要变换，并不是一个简单工作（因为在我开完会议以后，大家虽然都一致认可，但是实际开发中有些开发依然思路转换不过来），所以后续工作我需要先做一些demo（改造项目中已有的部分组件），然后逐步推广，而这期间需要跟leader、产品、设计和后台都需要统一意识：
> + 后台：如果每个应用的组件都有类似的接口，这样的工作必然事半功倍。
> + 设计：如果有基本的规范能使得到工作很大的保障，据我所知设计那边已经有规范形成，只是旧设计依然有很多残留在项目中，这应该问题不大
> + 产品&leader：这样的改动需要时间，而且合作方式也会改变，以前是这个迭代某个应用的某个功能改版，那负责应用的人参加会议即可，现在的话需要这个功能的负责人参会，如果是整个应用的改动，则这个应用所有用到的功能模块的人都需要开会，当然这样的模块拆分粒度不会太细。


+ 一次性将整个产品改动是不可能的，这样的改动虽然很大，但是依然能够逐步实现：
> 1. 先划分模块，粗粒度的划分一些功能比较大的相似模块，像：筛选模块、导航&header&footer、列表模块，创建&编辑表单模块等
> 2. 逐步封装部分应用，初期可以大量的使用ifelse判断，先将组件统一封装，不考虑质量，只是做简单的代码迁移
> 3. 安排人员逐个优化模块，将内部的通用部分提取，特性部分按策略模式配置化，这个工作同时可以结合产品的需求改动，产品可以将大范围的相同功能的改动安排到一起，这样在优化的过程中也不会太耽搁产品的迭代
> 4. 将模块打包成npm包，使用时自动生成到应用中即可